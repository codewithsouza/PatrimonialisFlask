{% extends 'admin/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Dashboard Administrativo</h2>
  <a href="{{ url_for('notificacoes.notificacoes_index') }}" class="btn btn-outline-primary">
    <i class="fas fa-bell me-2"></i> Notificações
  </a>
</div>
<div class="row g-3 mb-3">
  <div class="col-sm-12 col-md-4">
    <a href="{{ url_for('admin.clientes_cadastrados') }}" class="text-decoration-none">
      <div class="card text-white bg-primary" style="min-height: 220px;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
          <h5 class="card-title fs-1">{{ total_clientes }}</h5>
          <p class="card-text fs-5 text-white">Empresas Gerenciadas</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-sm-12 col-md-4">
    <a href="{{ url_for('admin.divida_ativa') }}" class="text-decoration-none">
      <div class="card text-white bg-success" style="min-height: 220px;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
          <h5 class="card-title fs-1">
            R$ {{ "{:,.2f}".format(total_divida | float).replace(',', 'X').replace('.', ',').replace('X', '.') }}
          </h5>
          <p class="card-text fs-5 text-white">Dívida Consolidada</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-sm-12 col-md-4">
    <div class="card text-white bg-danger" style="min-height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
        <h5 class="card-title fs-1">{{ processos_ativos }}</h5>
        <p class="card-text fs-5">Processos Judiciais Ativos</p>
      </div>
    </div>
  </div>
</div>

<!-- Seção de Gráficos -->
<div class="row g-3 mb-3">
  <div class="col-sm-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body text-center">
        <h5 class="card-title">Composição da Dívida</h5>
        <canvas id="graficoPizza" style="max-height: 200px;"></canvas>
      </div>
    </div>
  </div>
  <div class="col-sm-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body text-center">
        <h5 class="card-title">Status das Dívidas</h5>
        <canvas id="graficoBarra" style="max-height: 200px;"></canvas>
      </div>
    </div>
  </div>
  <div class="col-sm-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body text-center">
        <h5 class="card-title">Potencial de Reduções</h5>
        <canvas id="graficoDonut" style="max-height: 180px;"></canvas>
        <p class="mt-3 fw-bold">Potencial de Redução Total:<br> R$ 850.000</p>
      </div>
    </div>
  </div>
</div>

<!-- Seção de Alertas -->
<div class="row g-3">
  <div class="col-sm-12 col-md-6 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Alertas</h5>
        <ul class="list-group">
          <li class="list-group-item list-group-item-warning">Certidão Negativa de Díbitos expirando em breve</li>
          <li class="list-group-item list-group-item-danger">Prazo judicial crítico se aproximando</li>
          <li class="list-group-item list-group-item-warning">Acordo em risco de rescisão</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function carregarGrafico() {
    const response = await fetch("/admin/api/grafico_dividas");
    const data = await response.json();

    const ctx = document.getElementById('graficoPizza').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: data.labels,
        datasets: [{
          data: data.valores,
          backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'],
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', carregarGrafico);
</script>
{% endblock %}