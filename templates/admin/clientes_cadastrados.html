{% extends 'admin/index.html' %}

{% block content %}
<div class="container">
    <h2 class="mt-4">Clientes Cadastrados</h2>

    <div class="row mt-4 align-items-end">
        <!-- Esquerda: BotÃ£o de Importar e Adicionar -->
        <div class="col-md-6 d-flex gap-2">
            <!-- ðŸ”¹ FormulÃ¡rio de Importar CSV/Excel -->
            <form id="formImportar" method="POST" action="{{ url_for('admin.importar') }}" enctype="multipart/form-data">
                <input type="file" id="inputArquivo" name="file" accept=".xlsx, .csv" hidden required>
                <label for="inputArquivo" class="btn btn-success w-100" style="min-width: 200px;">
                    <i class="fas fa-file-import"></i> Importar Excel
                </label>
            </form>

            <!-- BotÃ£o de Adicionar Cliente (abre modal) -->
            <button class="btn btn-primary w-100" style="min-width: 200px;" data-bs-toggle="modal" data-bs-target="#modalAdicionar">
                <i class="fas fa-plus"></i> Adicionar Cliente
            </button>
        </div>

        <!-- Direita: Pesquisa e Exportar -->
        <div class="col-md-6 d-flex gap-2 justify-content-end">
            <input type="text" class="form-control" id="searchInput" placeholder="Pesquisar Cliente..." style="max-width: 250px;">
            <a href="{{ url_for('admin.exportar') }}" class="btn btn-warning w-100" style="min-width: 200px;">
                <i class="fas fa-file-download"></i> Exportar CSV
            </a>
        </div>
    </div>

    <!-- Tabela de Clientes -->
    <div class="table-responsive">
        <table class="table table-hover mt-4">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>CNPJ</th>
                    <th>Regime</th>
                    <th>DÃ­vida</th>
                    <th>Contrato</th>
                    <th>Segmento</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="clientesTable">
                {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.id }}</td>
                    <td>{{ cliente.nome }}</td>
                    <td class="cnpj">{{ cliente.cnpj }}</td>
                    <td>{{ cliente.regime }}</td>
                    <td class="divida">R$ {{ cliente.divida | round(2) }}</td>
                    <td>{{ cliente.contrato }}</td>  <!-- Corrigido para 'contrato' -->
                    <td>{{ cliente.segmento }}</td>
                    <td>
                        <button class="btn btn-warning btn-sm edit-btn" data-id="{{ cliente.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="{{ cliente.id }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Adicionar Cliente -->
<div class="modal fade" id="modalAdicionar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAdicionar">
                    <input type="text" name="nome" class="form-control mb-2" placeholder="Nome" required>
                    <input type="text" name="cnpj" class="form-control mb-2" placeholder="CNPJ" required>
                    <input type="text" name="regime" class="form-control mb-2" placeholder="Regime" required>
                    <input type="number" step="0.01" name="divida" class="form-control mb-2" placeholder="DÃ­vida" required>

                    <label for="contrato">Contrato</label>
                    <select name="contrato" class="form-control mb-2" required>
                        <option value="Ativo">Ativo</option>
                        <option value="Encerrado">Encerrado</option>
                    </select>

                    <label for="segmento">Segmento</label>
                    <select name="segmento" class="form-control mb-2" required>
                        <option value="" disabled selected>Escolha um segmento</option>
                        <option value="ComÃ©rcio">ComÃ©rcio</option>
                        <option value="PrestaÃ§Ã£o de ServiÃ§os">PrestaÃ§Ã£o de ServiÃ§os</option>
                        <option value="IndÃºstria">IndÃºstria</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Rural">Rural</option>
                        <option value="3Âº Setor">3Âº Setor</option>
                    </select>

                    <button type="submit" class="btn btn-primary w-100">Adicionar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        carregarClientes();

        // ðŸ”¹ Submeter formulÃ¡rio de adicionar cliente via JSON fetch
        document.getElementById("formAdicionar").addEventListener("submit", async function (e) {
            e.preventDefault();
            let formData = new FormData(this);
            let clienteData = {
                nome: formData.get("nome"),
                cnpj: formData.get("cnpj"),
                regime: formData.get("regime"),
                divida: parseFloat(formData.get("divida")),
                contrato: formData.get("contrato"),
                segmento: formData.get("segmento"),
            };

            let response = await fetch("/admin/adicionar_cliente", {
                method: "POST",
                body: JSON.stringify(clienteData),
                headers: { "Content-Type": "application/json" }
            });

            let result = await response.json();
            alert(result.message);

            // Recarregar a lista
            carregarClientes();

            // Fechar o modal
            let modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("modalAdicionar"));
            modal.hide();
        });

        // ðŸ”¹ Carrega a lista de clientes dinamicamente
        async function carregarClientes() {
            let response = await fetch('/admin/clientes_cadastrados');
            let data = await response.text();

            // Converte a string HTML para um DOM
            let parser = new DOMParser();
            let newDoc = parser.parseFromString(data, 'text/html');

            // Copia o conteÃºdo do <tbody id="clientesTable">
            let newTable = newDoc.getElementById("clientesTable").innerHTML;
            document.getElementById("clientesTable").innerHTML = newTable;
        }

        // ðŸ”¹ Excluir cliente via JSON fetch
        document.addEventListener("click", async function (event) {
            if (event.target.closest(".delete-btn")) {
                let id = event.target.closest("tr").querySelector("td").innerText;

                if (confirm(`Tem certeza que deseja excluir o cliente ID ${id}?`)) {
                    let response = await fetch(`/admin/excluir_cliente/${id}`, { method: "POST" });
                    let result = await response.json();
                    alert(result.message);

                    // Recarrega a lista
                    carregarClientes();
                }
            }
        });
    });
</script>

{% endblock %}
